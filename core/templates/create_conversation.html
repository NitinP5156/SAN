{% extends 'base.html' %}
{% load static %}

{% block title %}New Conversation - SAN-NET{% endblock %}

{% block extra_head %}
<style>
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .animate-fade-in {
        opacity: 0;
        animation: fadeIn 0.5s ease-out forwards;
    }
    
    .animate-fade-in-delay-1 {
        opacity: 0;
        animation: fadeIn 0.5s ease-out 0.1s forwards;
    }
    
    .animate-fade-in-delay-2 {
        opacity: 0;
        animation: fadeIn 0.5s ease-out 0.2s forwards;
    }
    
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.2); }
        70% { box-shadow: 0 0 0 8px rgba(79, 70, 229, 0); }
        100% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); }
    }
    
    .search-pulse {
        animation: pulse 2s infinite;
    }
    
    .user-option:hover {
        background-color: rgba(79, 70, 229, 0.1);
    }
    
    .user-option {
        transition: all 0.2s ease;
    }
    
    .selected-user {
        animation: fadeIn 0.3s ease-out forwards;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-indigo-50 via-white to-purple-50 dark:from-gray-900 dark:via-gray-800 dark:to-gray-900 py-12">
    <div class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 border border-indigo-100 dark:border-gray-700 animate-fade-in">
            <div class="mb-6">
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white">New Conversation</h1>
                <p class="text-gray-600 dark:text-gray-400 mt-1">Start a conversation with one or more people</p>
            </div>

            <form method="POST" class="space-y-6" enctype="multipart/form-data">
                {% csrf_token %}
                
                <!-- User Selection -->
                <div class="animate-fade-in-delay-1">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Search Users</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </div>
                        <input
                            type="text"
                            id="user-search"
                            placeholder="Type a name or username..."
                            class="w-full pl-10 pr-4 py-2 rounded-xl border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 search-pulse"
                            autocomplete="off"
                        >
                        <div id="search-results" class="hidden absolute z-10 w-full mt-1 bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 max-h-60 overflow-y-auto">
                            <!-- Search results will be populated here -->
                        </div>
                    </div>

                    <!-- Selected Users -->
                    <div id="selected-users" class="mt-4 flex flex-wrap gap-2">
                        <!-- Selected users will be added here -->
                    </div>
                    
                    <div id="no-users-selected" class="mt-4 text-sm text-gray-500 dark:text-gray-400 text-center">
                        <p>Search and select users to start a conversation</p>
                    </div>
                </div>

                <!-- Group Chat Options -->
                <div id="group-options" class="hidden space-y-4 animate-fade-in-delay-2">
                    <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                        <h3 class="text-md font-medium text-gray-900 dark:text-white mb-3">Group Chat Options</h3>
                    </div>
                    
                    <div>
                        <label for="group-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Group Name</label>
                        <div class="relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                </svg>
                            </div>
                            <input
                                type="text"
                                id="group-name"
                                name="name"
                                placeholder="Enter group name..."
                                class="w-full pl-10 pr-3 py-2 rounded-xl border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400"
                            >
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Group Image (Optional)</label>
                        <div class="flex items-center space-x-4">
                            <div id="group-image-preview" class="hidden w-16 h-16 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center overflow-hidden">
                                <img src="" alt="Group" class="w-full h-full object-cover">
                            </div>
                            <label class="cursor-pointer inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-xl text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                Choose Image
                                <input type="file" name="image" class="hidden" accept="image/*" onchange="previewGroupImage(event)">
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Submit Buttons -->
                <div class="flex justify-end space-x-4 pt-4 border-t border-gray-200 dark:border-gray-700 animate-fade-in-delay-2">
                    <a
                        href="{% url 'core:messages' %}"
                        class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-xl transition-colors duration-200"
                    >
                        Cancel
                    </a>
                    <button
                        type="submit"
                        id="submit-button"
                        class="px-4 py-2 text-sm font-medium text-white bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 rounded-xl transition-colors duration-200 opacity-50 cursor-not-allowed"
                        disabled
                    >
                        Start Conversation
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Use Django's json_script to safely pass data to JavaScript -->
{{ users|json_script:"users-data" }}
{% endblock %}

{% block extra_js %}
<script>
// Get users data from the script tag generated by json_script
const users = JSON.parse(document.getElementById('users-data').textContent);

const searchInput = document.getElementById('user-search');
const searchResults = document.getElementById('search-results');
const selectedUsers = document.getElementById('selected-users');
const noUsersSelected = document.getElementById('no-users-selected');
const groupOptions = document.getElementById('group-options');
const submitButton = document.getElementById('submit-button');
const selectedUserIds = new Set();

// Search functionality
searchInput.addEventListener('input', function() {
    const query = this.value.toLowerCase().trim();
    
    if (query.length < 2) {
        searchResults.classList.add('hidden');
        return;
    }
    
    // Show loading indicator
    searchResults.innerHTML = `
        <div class="p-3 text-center text-gray-500 dark:text-gray-400">
            <svg class="animate-spin h-5 w-5 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-1">Searching...</p>
        </div>
    `;
    searchResults.classList.remove('hidden');
    
    // Debounce the search request
    if (window.searchTimeout) {
        clearTimeout(window.searchTimeout);
    }
    
    window.searchTimeout = setTimeout(() => {
        // Make API request to search users
        fetch(`/messages/search-users/?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                if (data.users && data.users.length > 0) {
                    searchResults.innerHTML = data.users.map(user => {
                        // Don't show already selected users
                        if (selectedUserIds.has(user.id)) return '';
                        
                        return `
                            <div class="user-option p-3 cursor-pointer" data-user-id="${user.id}">
                                <div class="flex items-center space-x-3">
                                    ${user.profile_picture 
                                        ? `<img src="${user.profile_picture}" alt="${user.username}" class="h-10 w-10 rounded-full object-cover">`
                                        : `<div class="h-10 w-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center text-white font-bold">
                                            ${user.username.charAt(0).toUpperCase()}
                                           </div>`
                                    }
                                    <div>
                                        <div class="font-medium text-gray-900 dark:text-white">${user.username}</div>
                                        ${user.email ? `<div class="text-sm text-gray-500 dark:text-gray-400">${user.email}</div>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    searchResults.innerHTML = `
                        <div class="p-3 text-center text-gray-500 dark:text-gray-400">
                            No users found matching "${query}"
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error searching users:', error);
                searchResults.innerHTML = `
                    <div class="p-3 text-center text-red-500">
                        Error searching users. Please try again.
                    </div>
                `;
            });
    }, 300); // 300ms delay to avoid too many requests
});

// Handle user selection
searchResults.addEventListener('click', function(e) {
    const userOption = e.target.closest('.user-option');
    if (userOption) {
        const userId = parseInt(userOption.dataset.userId);
        const user = users.find(u => u.id === userId);
        
        if (!selectedUserIds.has(userId)) {
            selectedUserIds.add(userId);
            selectedUsers.insertAdjacentHTML('beforeend', `
                <div class="selected-user inline-flex items-center px-3 py-1 rounded-full bg-indigo-100 dark:bg-indigo-900 text-indigo-800 dark:text-indigo-200" data-user-id="${user.id}">
                    <span class="mr-1">${user.username}</span>
                    <button type="button" class="ml-1 focus:outline-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                    <input type="hidden" name="users" value="${user.id}">
                </div>
            `);
            
            // Update UI state
            updateUIState();
        }
        
        searchInput.value = '';
        searchResults.classList.add('hidden');
    }
});

// Remove selected user
selectedUsers.addEventListener('click', function(e) {
    if (e.target.closest('button')) {
        const selectedUser = e.target.closest('.selected-user');
        const userId = parseInt(selectedUser.dataset.userId);
        selectedUserIds.delete(userId);
        selectedUser.remove();
        
        // Update UI state
        updateUIState();
    }
});

// Group image preview
function previewGroupImage(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('group-image-preview');
            preview.querySelector('img').src = e.target.result;
            preview.classList.remove('hidden');
        }
        reader.readAsDataURL(file);
    }
}

// Update UI state based on selected users
function updateUIState() {
    const userCount = selectedUserIds.size;
    
    // Show/hide no users message
    if (userCount > 0) {
        noUsersSelected.classList.add('hidden');
    } else {
        noUsersSelected.classList.remove('hidden');
    }
    
    // Show/hide group options
    if (userCount > 1) {
        groupOptions.classList.remove('hidden');
    } else {
        groupOptions.classList.add('hidden');
    }
    
    // Enable/disable submit button
    if (userCount > 0) {
        submitButton.disabled = false;
        submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
    } else {
        submitButton.disabled = true;
        submitButton.classList.add('opacity-50', 'cursor-not-allowed');
    }
}

// Close search results when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('#user-search') && !e.target.closest('#search-results')) {
        searchResults.classList.add('hidden');
    }
});

// Initialize UI
searchInput.focus();
</script>
{% endblock %} 