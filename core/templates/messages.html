{% extends 'base.html' %}
{% load static %}

{% block title %}Messages - Social Media{% endblock %}

{% block extra_head %}
<style>
    .messages-container {
        height: calc(100vh - 220px);
        overflow-y: auto;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        background-color: #f8f9fa;
        border-radius: 8px;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .dark .messages-container {
        background-color: #2d3748;
    }
    
    .message {
        display: flex;
        margin-bottom: 0.75rem;
        animation: fadeIn 0.3s ease-out;
    }
    
    .message-sent {
        justify-content: flex-end;
    }
    
    .message-received {
        justify-content: flex-start;
    }
    
    .message-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        overflow: hidden;
        flex-shrink: 0;
    }
    
    .message-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .message-content {
        padding: 0.75rem 1rem;
        border-radius: 18px;
        max-width: 70%;
        word-wrap: break-word;
    }
    
    .message-sent .message-content {
        background-color: #6366f1;
        color: white;
        border-bottom-right-radius: 4px;
        margin-right: 0.5rem;
    }
    
    .message-received .message-content {
        background-color: white;
        color: #1a202c;
        border-bottom-left-radius: 4px;
        margin-left: 0.5rem;
    }
    
    .dark .message-received .message-content {
        background-color: #4a5568;
        color: #e2e8f0;
    }
    
    .message-content small {
        display: block;
        font-size: 0.7rem;
        margin-top: 0.25rem;
        opacity: 0.8;
    }
    
    .conversation-list {
        border-right: 1px solid #e2e8f0;
        height: calc(100vh - 80px);
        overflow-y: auto;
    }
    
    .dark .conversation-list {
        border-right-color: #4a5568;
    }
    
    .conversation-item {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #e2e8f0;
        transition: all 0.2s;
    }
    
    .dark .conversation-item {
        border-bottom-color: #4a5568;
    }
    
    .conversation-item:hover {
        background-color: #f3f4f6;
    }
    
    .dark .conversation-item:hover {
        background-color: #2d3748;
    }
    
    .conversation-item.active {
        background-color: #e0e7ff;
        border-left: 3px solid #6366f1;
    }
    
    .dark .conversation-item.active {
        background-color: #3730a3;
    }
    
    .message-form {
        display: flex;
        padding: 1rem;
        border-top: 1px solid #e2e8f0;
        background-color: white;
        border-radius: 0 0 8px 8px;
        position: sticky;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 10;
    }
    
    .dark .message-form {
        background-color: #2d3748;
        border-top-color: #4a5568;
    }
    
    .message-input {
        flex: 1;
        padding: 0.75rem 1rem;
        border: 1px solid #e2e8f0;
        border-radius: 24px;
        background-color: #f8f9fa;
        resize: none;
        max-height: 100px;
        min-height: 44px;
        outline: none;
        transition: all 0.2s;
    }
    
    .dark .message-input {
        background-color: #4a5568;
        border-color: #4a5568;
        color: #e2e8f0;
    }
    
    .message-input:focus {
        border-color: #6366f1;
        box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
    }
    
    .send-button {
        margin-left: 0.5rem;
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background-color: #6366f1;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .send-button:hover {
        background-color: #4f46e5;
    }
    
    .send-button:disabled {
        background-color: #c7d2fe;
        cursor: not-allowed;
    }
    
    .dark .send-button:disabled {
        background-color: #6b7280;
    }
    
    .message-thread {
        display: flex;
        flex-direction: column;
        height: 100%;
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Empty state styles */
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #6b7280;
        text-align: center;
        padding: 2rem;
    }
    
    .empty-state svg {
        width: 64px;
        height: 64px;
        margin-bottom: 1rem;
        color: #9ca3af;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-indigo-50 via-white to-purple-50 dark:from-gray-900 dark:via-gray-800 dark:to-gray-900 py-12">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl border border-indigo-100 dark:border-gray-700 overflow-hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 h-[calc(100vh-8rem)]">
                <!-- Conversations List -->
                <div class="conversation-list">
                    <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Messages</h1>
                            <a href="{% url 'core:create_conversation' %}" class="p-2 rounded-full bg-indigo-600 text-white hover:bg-indigo-700 transition-colors duration-200" title="New Message">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                            </a>
                        </div>
                        <div class="mt-4 relative">
                            <input
                                type="text"
                                placeholder="Search conversations..."
                                class="w-full px-4 py-2 rounded-xl border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400"
                            >
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute right-3 top-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </div>
                    </div>

                    <div class="overflow-y-auto h-[calc(100%-5rem)]">
                        {% for conversation in conversations %}
                            <a href="{% url 'core:messages' conversation_id=conversation.id %}" class="block">
                                <div class="conversation-item {% if conversation.unread %}bg-indigo-50 dark:bg-indigo-900/20{% endif %} {% if selected_conversation and selected_conversation.id == conversation.id %}active{% endif %}">
                                    <div class="flex items-center space-x-3">
                                        {% if conversation.other_user.profile_picture %}
                                            <img src="{{ conversation.other_user.profile_picture.url }}" alt="Profile" class="h-12 w-12 rounded-full object-cover">
                                        {% else %}
                                            <div class="h-12 w-12 rounded-full bg-gradient-to-br from-indigo-100 to-purple-100 dark:from-indigo-900 dark:to-purple-900 flex items-center justify-center">
                                                <i class="fas fa-user text-xl text-indigo-600 dark:text-indigo-400"></i>
                                            </div>
                                        {% endif %}
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-center justify-between">
                                                <h2 class="text-sm font-semibold text-gray-900 dark:text-white truncate">
                                                    {{ conversation.other_user.username }}
                                                </h2>
                                                <span class="text-xs text-gray-500 dark:text-gray-400">
                                                    {% if conversation.display_message %}
                                                        {{ conversation.display_message.created_at|timesince }} ago
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <p class="text-sm text-gray-500 dark:text-gray-400 truncate">
                                                {% if conversation.display_message %}
                                                    {{ conversation.display_message.content }}
                                                {% else %}
                                                    No messages yet
                                                {% endif %}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        {% empty %}
                            <div class="empty-state">
                                <div class="text-4xl text-indigo-400 dark:text-indigo-500 mb-4">
                                    <i class="fas fa-comments"></i>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">No messages yet</h3>
                                <p class="text-gray-500 dark:text-gray-400">Start a conversation with someone!</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Message Thread -->
                <div class="col-span-2 flex flex-col h-full">
                    {% if selected_conversation %}
                        <!-- Chat Header -->
                        <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                {% if selected_conversation.other_user.profile_picture %}
                                    <img src="{{ selected_conversation.other_user.profile_picture.url }}" alt="Profile" class="h-10 w-10 rounded-full object-cover">
                                {% else %}
                                    <div class="h-10 w-10 rounded-full bg-gradient-to-br from-indigo-100 to-purple-100 dark:from-indigo-900 dark:to-purple-900 flex items-center justify-center">
                                        <i class="fas fa-user text-lg text-indigo-600 dark:text-indigo-400"></i>
                                    </div>
                                {% endif %}
                                <div>
                                    <h2 class="font-semibold text-gray-900 dark:text-white">
                                        {{ selected_conversation.other_user.username }}
                                    </h2>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">
                                        {% if selected_conversation.other_user.is_online %}
                                            <span class="text-green-500">● Online</span>
                                        {% else %}
                                            Last seen {{ selected_conversation.other_user.last_seen|timesince }} ago
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button class="p-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300">
                                    <i class="fas fa-phone"></i>
                                </button>
                                <button class="p-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300">
                                    <i class="fas fa-video"></i>
                                </button>
                                <button class="p-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                            </div>
                        </div>

                        <div class="message-thread flex-grow flex flex-col">
                            <!-- Messages -->
                            <div class="messages-container flex-grow overflow-y-auto" id="messages-container">
                                {% for message in message_list %}
                                    <div class="message {% if message.sender == user %}message-sent{% else %}message-received{% endif %}" data-message-id="{{ message.id }}">
                                        {% if message.sender != user %}
                                        <div class="message-avatar">
                                            {% if message.sender.profile_picture %}
                                                <img src="{{ message.sender.profile_picture.url }}" alt="{{ message.sender.username }}">
                                            {% else %}
                                                <img src="{% static 'images/default_avatar.png' %}" alt="{{ message.sender.username }}">
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                        
                                        <div class="message-content">
                                            <p>{{ message.content }}</p>
                                            <small>{{ message.created_at|time:"g:i A" }}</small>
                                        </div>
                                        
                                        {% if message.sender == user %}
                                        <div class="message-avatar">
                                            {% if message.sender.profile_picture %}
                                                <img src="{{ message.sender.profile_picture.url }}" alt="{{ message.sender.username }}">
                                            {% else %}
                                                <img src="{% static 'images/default_avatar.png' %}" alt="{{ message.sender.username }}">
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                    </div>
                                {% empty %}
                                    <div class="empty-state">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                                        </svg>
                                        <h3 class="text-lg font-medium text-gray-900 dark:text-white mt-4">No messages yet</h3>
                                        <p class="text-gray-500 dark:text-gray-400 mt-2">Send the first message to start the conversation</p>
                                    </div>
                                {% endfor %}
                            </div>

                            <!-- Message Input -->
                            <div class="message-form">
                                <form id="message-form" class="flex w-full items-center" action="{% url 'core:send_message' conversation_id=selected_conversation.id %}" method="post">
                                    {% csrf_token %}
                                    <button type="button" class="p-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300">
                                        <i class="fas fa-paperclip"></i>
                                    </button>
                                    <input
                                        type="text"
                                        name="content"
                                        class="message-input"
                                        placeholder="Type a message..."
                                        autocomplete="off"
                                    >
                                    <button type="submit" class="send-button">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                    {% else %}
                        <!-- No Conversation Selected -->
                        <div class="flex-1 flex items-center justify-center">
                            <div class="empty-state">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                                </svg>
                                <h2 class="text-xl font-semibold text-gray-900 dark:text-white mt-4">Select a Conversation</h2>
                                <p class="text-gray-500 dark:text-gray-400 mt-2">Choose a conversation from the list to start messaging</p>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Store current user data from Django in JavaScript variables
const currentUserId = "{{ user.id }}";
const userAvatar = "{% if user.profile_picture %}{{ user.profile_picture.url }}{% else %}{% static 'images/default_avatar.png' %}{% endif %}";
const username = "{{ user.username }}";
const defaultAvatar = "{% static 'images/default_avatar.png' %}";

document.addEventListener('DOMContentLoaded', function() {
    const messagesContainer = document.getElementById('messages-container');
    if (messagesContainer) {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Handle message form submission
    const messageForm = document.getElementById('message-form');
    if (messageForm) {
        messageForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const input = this.querySelector('input[name="content"]');
            const message = input.value.trim();
            
            if (message) {
                const formData = new FormData(this);
                const url = this.getAttribute('action');
                
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Create and append new message element
                        const messageElement = document.createElement('div');
                        messageElement.className = 'message message-sent';
                        messageElement.setAttribute('data-message-id', data.message.id);
                        
                        messageElement.innerHTML = `
                            <div class="message-content">
                                <p>${data.message.content}</p>
                                <small>${data.message.time}</small>
                            </div>
                            <div class="message-avatar">
                                <img src="${userAvatar}" alt="${username}">
                            </div>
                        `;
                        
                        // Add to container and scroll to bottom
                        messagesContainer.appendChild(messageElement);
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
                
                // Clear the input field
                input.value = '';
            }
        });
    }
    
    // Check for new messages periodically
    if (messagesContainer) {
        // Get conversation ID from URL
        const urlParts = window.location.pathname.split('/');
        const conversationId = urlParts[urlParts.length - 2]; 
        
        if (conversationId) {
            setInterval(function() {
                // Get the latest message ID
                const messages = document.querySelectorAll('.message');
                let lastId = 0;
                
                if (messages.length > 0) {
                    const lastMessage = messages[messages.length - 1];
                    lastId = lastMessage.getAttribute('data-message-id');
                }
                
                // Fetch new messages
                fetch(`/messages/${conversationId}/updates/?last_message_id=${lastId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.messages && data.messages.length > 0) {
                            data.messages.forEach(message => {
                                // Check if message already exists
                                if (!document.querySelector(`[data-message-id="${message.id}"]`)) {
                                    // Create and append new message
                                    const messageElement = document.createElement('div');
                                    
                                    // Determine if the message is from current user
                                    const isCurrentUser = message.sender_id == currentUserId;
                                    messageElement.className = isCurrentUser ? 'message message-sent' : 'message message-received';
                                    messageElement.setAttribute('data-message-id', message.id);
                                    
                                    if (isCurrentUser) {
                                        messageElement.innerHTML = `
                                            <div class="message-content">
                                                <p>${message.content}</p>
                                                <small>${message.time}</small>
                                            </div>
                                            <div class="message-avatar">
                                                <img src="${userAvatar}" alt="${username}">
                                            </div>
                                        `;
                                    } else {
                                        messageElement.innerHTML = `
                                            <div class="message-avatar">
                                                <img src="${defaultAvatar}" alt="${message.sender}">
                                            </div>
                                            <div class="message-content">
                                                <p>${message.content}</p>
                                                <small>${message.time}</small>
                                            </div>
                                        `;
                                    }
                                    
                                    // Add to container and scroll to bottom
                                    messagesContainer.appendChild(messageElement);
                                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                                }
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching new messages:', error);
                    });
            }, 3000); // Check every 3 seconds
        }
    }
});
</script>
{% endblock %} 